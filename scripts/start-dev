#!/bin/bash
set -e

. `dirname "$0"`/environ.sh
init ${1-demo}

# export NODE_OPTIONS='--prof'
# send SIGUSR1 to debug
if test -e npm-shrinkwrap.json;then
    if test -e tmp/npm-shrinkwrap.json && diff -q npm-shrinkwrap.json tmp/npm-shrinkwrap.json >/dev/null;then
        echo 'node_modules okay'
    else
        npm install
        cp npm-shrinkwrap.json tmp/npm-shrinkwrap.json
    fi
fi

cd app
echo -e "starting ${branch}...\c"
exec ${NODEDEBUG-node} --es_staging ../node_modules/koru/lib/koru.js "$@"
