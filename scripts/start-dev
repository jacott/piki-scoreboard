#!/bin/bash
set -e

. `dirname "$0"`/environ.sh
init ${1-demo}

# export NODE_OPTIONS='--prof'
# send SIGUSR1 to debug
if [[ -e tmp/yarn.lock && -e node_modules ]] && ${NODE} -v | cat - yarn.lock | diff -q - tmp/yarn.lock >/dev/null;then
    echo 'node_modules okay'
else
    echo 'yarn install...'
    rm -rf node_modules
    mkdir -p tmp
    yarn
    ${NODE} -v | cat - yarn.lock >tmp/yarn.lock
fi

cd app
echo -e "starting ${branch}...\c"
exec ${NODE} $NODE_DEBUG --es_staging ../node_modules/koru/lib/koru.js "$@"
